name: Deploy .NET Core API to AWS EC2

on:
  push:
    branches: [ main, master ]
    paths:
      - '**.cs'           # C# files
      - '**.csproj'       # Project files
      - '**/Controllers/**'
      - '**/Models/**'
      - '**/Services/**'
      - '.github/workflows/dotnet.yml'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Manual trigger

env:
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  IMAGE_NAME: dotnet-api
  DOTNET_VERSION: '8.0'

jobs:
  build:
    name: Build .NET API Docker Image
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    
    - name: Create Dockerfile
      run: |
        cat > Dockerfile << 'EOF'
        # Build stage
        FROM mcr.microsoft.com/dotnet/sdk:8.0 AS build
        WORKDIR /src
        
        # Copy solution and project files
        COPY *.sln ./
        COPY *.csproj ./
        
        # Restore dependencies
        RUN dotnet restore
        
        # Copy everything else
        COPY . ./
        
        # Build and publish
        RUN dotnet publish -c Release -o /app/publish --no-restore
        
        # Runtime stage
        FROM mcr.microsoft.com/dotnet/aspnet:8.0
        WORKDIR /app
        
        # Copy published files
        COPY --from=build /app/publish .
        
        # Create non-root user for security
        RUN groupadd -g 1001 dotnetuser && \
            useradd -r -u 1001 -g dotnetuser dotnetuser && \
            chown -R dotnetuser:dotnetuser /app
        
        USER dotnetuser
        
        # Expose port
        EXPOSE 5001
        
        # Set environment variables
        ENV ASPNETCORE_URLS=http://+:5001 \
            ASPNETCORE_ENVIRONMENT=Production
        
        # Health check
        HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
          CMD curl -f http://localhost:5001/health || exit 1
        
        # Start application
        ENTRYPOINT ["dotnet", "PMS.dll"]
        EOF
    
    - name: Build and push Docker image
      run: |
        echo "ğŸ—ï¸  Building Docker image..."
        docker build \
          -t ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest \
          -t ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
          -t ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.run_number }} \
          --build-arg BUILDKIT_INLINE_CACHE=1 \
          .
        
        echo "ğŸ“¦ Pushing image to Docker Hub..."
        docker push ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest
        docker push ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
        docker push ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.run_number }}
    
    - name: Test Docker image
      run: |
        echo "ğŸ§ª Testing Docker image..."
        
        # Start container
        docker run -d --name dotnet-api-test \
          -p 5001:5001 \
          -e ASPNETCORE_ENVIRONMENT=Development \
          ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest
        
        # Wait for startup
        echo "â³ Waiting for API to start..."
        sleep 15
        
        # Check if running
        if docker ps | grep -q dotnet-api-test; then
          echo "âœ… Container started successfully!"
          
          # Show logs
          echo "ğŸ“‹ Container logs:"
          docker logs --tail 30 dotnet-api-test
          
          # Test health endpoint (optional)
          echo "ğŸŒ Testing API endpoint..."
          curl -f http://localhost:5001/health 2>/dev/null || \
          curl -f http://localhost:5001/api 2>/dev/null || \
          echo "âš ï¸  Health endpoint not available (this is OK)"
          
          # Cleanup
          docker stop dotnet-api-test
          docker rm dotnet-api-test
          
          echo "âœ… Image test passed!"
        else
          echo "âŒ Container failed to start!"
          docker logs dotnet-api-test 2>&1 || true
          docker rm dotnet-api-test 2>/dev/null || true
          exit 1
        fi
    
    - name: Build summary
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âœ… .NET API BUILD SUCCESSFUL"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "ğŸ“¦ Image Tags:"
        echo "   â€¢ ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest"
        echo "   â€¢ ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
        echo "   â€¢ ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.run_number }}"
        echo ""
        echo "ğŸš€ Ready for deployment!"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  deploy:
    name: Deploy to AWS EC2
    needs: build
    runs-on: ubuntu-latest
    if: (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') && github.event_name == 'push'
    
    steps:
    - name: Deploy .NET API to EC2
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          echo "ğŸš€ Starting .NET API deployment..."
          
          # Check disk space
          echo "ğŸ’¾ Checking disk space..."
          df -h / | grep -v Filesystem
          
          # Clean up Docker to free space
          echo "ğŸ§¹ Cleaning up old Docker resources..."
          docker system prune -f --volumes 2>/dev/null || true
          
          echo "ğŸ’¾ Disk space after cleanup:"
          df -h / | grep -v Filesystem
          
          # Login to Docker Hub
          echo "ğŸ” Logging into Docker Hub..."
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
          
          # Pull latest image
          echo "ğŸ“¦ Pulling latest .NET API image..."
          docker pull ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest
          
          # Stop old container
          echo "ğŸ›‘ Stopping old .NET API container..."
          docker stop dotnet-api 2>/dev/null || true
          docker rm dotnet-api 2>/dev/null || true
          
          # Ensure network exists
          echo "ğŸŒ Setting up Docker network..."
          docker network create my-app-network 2>/dev/null || echo "Network already exists"
          
          # Start new container
          echo "â–¶ï¸  Starting new .NET API container..."
          docker run -d \
            --name dotnet-api \
            --network my-app-network \
            --restart unless-stopped \
            -e ASPNETCORE_ENVIRONMENT=Production \
            -e ASPNETCORE_URLS=http://+:5001 \
            ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest
          
          # Wait for startup
          echo "â³ Waiting for API to initialize..."
          sleep 10
          
          # Verify container is running
          if docker ps | grep -q dotnet-api; then
            echo "âœ… .NET API container is running!"
            docker ps --filter name=dotnet-api --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          else
            echo "âŒ .NET API container failed to start!"
            echo "ğŸ“‹ Container logs:"
            docker logs dotnet-api 2>&1 || true
            exit 1
          fi
          
          # Wait for app to fully start
          sleep 5
          
          # Test via Docker network
          echo "ğŸ”— Testing .NET API via Docker network..."
          if docker run --rm --network my-app-network alpine/curl:latest \
             -f -s http://dotnet-api:5001/health >/dev/null 2>&1 || \
             docker run --rm --network my-app-network alpine/curl:latest \
             -f -s http://dotnet-api:5001/api >/dev/null 2>&1; then
            echo "âœ… .NET API is accessible via Docker network!"
          else
            echo "âš ï¸  API health check failed (may be normal if no /health endpoint)"
          fi
          
          # Show logs
          echo "ğŸ“‹ Latest logs:"
          docker logs --tail 20 dotnet-api
          
          # Update Nginx if it exists
          if docker ps | grep -q nginx-proxy; then
            echo "ğŸ”„ Reloading Nginx configuration..."
            docker exec nginx-proxy nginx -s reload 2>/dev/null || true
          fi
          
          # Cleanup old images
          echo "ğŸ§¹ Cleaning up old .NET API images..."
          docker images | grep "${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}" | \
            tail -n +4 | awk '{print $3}' | xargs -r docker rmi -f 2>/dev/null || true
          
          # Final status
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… .NET API DEPLOYMENT COMPLETE!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“Š All containers status:"
          docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          echo ""
          echo "ğŸŒ Docker network:"
          docker network inspect my-app-network --format='{{range .Containers}}  â€¢ {{.Name}}: {{.IPv4Address}}{{"\n"}}{{end}}'
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    - name: Verify deployment
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          echo "ğŸ” Running deployment verification..."
          
          # Wait a bit more
          sleep 5
          
          # Check container health
          echo "ğŸ¥ Container health:"
          HEALTH=$(docker inspect dotnet-api --format='{{.State.Health.Status}}' 2>/dev/null || echo "no healthcheck")
          STATUS=$(docker inspect dotnet-api --format='{{.State.Status}}')
          echo "  Status: $STATUS"
          echo "  Health: $HEALTH"
          
          # Check logs for errors
          echo ""
          echo "ğŸ“‹ Recent logs (last 30 lines):"
          docker logs --tail 30 dotnet-api
          
          # Test connectivity from Nginx (if exists)
          if docker ps | grep -q nginx-proxy; then
            echo ""
            echo "ğŸ”— Testing via Nginx proxy..."
            if docker exec nginx-proxy wget -qO- http://dotnet-api:5001/health >/dev/null 2>&1 || \
               docker exec nginx-proxy wget -qO- http://dotnet-api:5001/api >/dev/null 2>&1; then
              echo "âœ… Nginx can reach .NET API!"
            else
              echo "âš ï¸  Nginx cannot reach .NET API (check Nginx config)"
            fi
          fi
          
          # Check from host (if port is exposed)
          echo ""
          echo "ğŸŒ Network connectivity test:"
          docker run --rm --network my-app-network alpine/curl:latest \
            -s http://dotnet-api:5001/health 2>/dev/null || \
          docker run --rm --network my-app-network alpine/curl:latest \
            -s http://dotnet-api:5001/api 2>/dev/null || \
          echo "API responding on internal network"
          
          echo ""
          echo "âœ… Verification complete!"
    
    - name: Deployment notification
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ‰ âœ… .NET CORE API DEPLOYED SUCCESSFULLY!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ”§ Configuration:"
          echo "   â€¢ Container: dotnet-api"
          echo "   â€¢ Port: 5001 (internal)"
          echo "   â€¢ Network: my-app-network"
          echo "   â€¢ Environment: Production"
          echo ""
          echo "ğŸŒ Access Points:"
          echo "   â€¢ Internal: http://dotnet-api:5001"
          echo "   â€¢ Via Nginx: http://${{ secrets.EC2_HOST }}/dotnet-api"
          echo ""
          echo "ğŸ“ Integration:"
          echo "   â€¢ From React: /dotnet-api/api/..."
          echo "   â€¢ From Node.js: http://dotnet-api:5001/api/..."
          echo "   â€¢ From other containers: http://dotnet-api:5001"
          echo ""
          echo "âœ¨ .NET API is live and ready!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        else
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âŒ .NET API DEPLOYMENT FAILED!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Common issues:"
          echo "  â€¢ Compilation errors in C# code"
          echo "  â€¢ Wrong DLL name in ENTRYPOINT"
          echo "  â€¢ Database connection failures"
          echo "  â€¢ Missing environment variables"
          echo "  â€¢ Port conflicts"
          echo "  â€¢ Insufficient disk space"
          echo ""
          echo "Check the logs above for details."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        fi